<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Pruebas - CCB</title>
    <style>
        body { font-family: sans-serif; margin: 2em; background-color: #f4f4f9; color: #333; }
        h1, h2 { color: #444; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .service-section { background-color: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 1.5em; margin-bottom: 2em; }
        form { display: flex; flex-direction: column; gap: 10px; margin-bottom: 1em; }
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; }
        button:hover { background-color: #0056b3; }
        #response-area { margin-top: 2em; }
        #response-output { background-color: #2d2d2d; color: #f8f8f2; padding: 1em; border-radius: 5px; white-space: pre-wrap; word-wrap: break-word; }
        .token-display { font-size: 0.9em; color: #555; word-break: break-all; }
    </style>
</head>
<body>
    <h1>Panel de Pruebas para Microservicios CCB</h1>

    <!-- Sección de Autenticación -->
    <div class="service-section">
        <h2>Servicio de Autenticación (Puerto 8081)</h2>
        <form id="register-form">
            <h3>Registrar Usuario</h3>
            <input type="text" id="reg-username" placeholder="Username" required>
            <input type="password" id="reg-password" placeholder="Password" required>
            <input type="email" id="reg-email" placeholder="Email" required>
            <button type="submit">Registrar</button>
        </form>
        <hr>
        <form id="login-form">
            <h3>Iniciar Sesión</h3>
            <input type="text" id="login-username" placeholder="Username" required>
            <input type="password" id="login-password" placeholder="Password" required>
            <button type="submit">Login</button>
        </form>
        <h3>Token JWT Actual:</h3>
        <p class="token-display" id="jwt-token">Ninguno</p>
    </div>

    <!-- Sección de Cursos -->
    <div class="service-section">
        <h2>Servicio de Cursos (Puerto 8082)</h2>
        <form id="create-course-form">
            <h3>Crear Curso (requiere token)</h3>
            <input type="text" id="course-title" placeholder="Título del curso" required>
            <input type="text" id="course-description" placeholder="Descripción del curso">
            <button type="submit">Crear Curso</button>
        </form>
        <hr>
        <button id="list-courses-btn">Listar Todos los Cursos</button>
    </div>

    <!-- Sección de Inscripciones -->
    <div class="service-section">
        <h2>Servicio de Inscripciones (Puerto 8083)</h2>
        <form id="enroll-form">
            <h3>Inscribirse en Curso (requiere token)</h3>
            <input type="text" id="enroll-course-id" placeholder="ID del Curso" required>
            <button type="submit">Inscribirse</button>
        </form>
        <hr>
        <button id="my-courses-btn">Ver Mis Cursos Inscritos</button>
    </div>

    <!-- Área de Respuesta -->
    <div id="response-area">
        <h2>Respuesta del API</h2>
        <pre id="response-output"><code>Esperando una acción...</code></pre>
    </div>

<script>
    const API_BASE_AUTH = 'http://localhost:8081';
    const API_BASE_COURSES = 'http://localhost:8082';
    const API_BASE_ENROLLMENTS = 'http://localhost:8083';

    const responseOutput = document.getElementById('response-output');
    const jwtTokenDisplay = document.getElementById('jwt-token');
    let currentJwt = null;

    // Función helper para hacer peticiones fetch
    async function apiFetch(url, options = {}) {
        responseOutput.textContent = 'Cargando...';
        try {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (currentJwt) {
                headers['Authorization'] = `Bearer ${currentJwt}`;
            }

            const response = await fetch(url, { ...options, headers });
            
            let responseData;
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                responseData = await response.json();
            } else {
                responseData = await response.text();
            }

            if (!response.ok) {
                throw { status: response.status, data: responseData };
            }

            return responseData;
        } catch (error) {
            console.error('API Error:', error);
            responseOutput.textContent = `Error ${error.status || ''}: ${JSON.stringify(error.data || error.message, null, 2)}`;
            throw error;
        }
    }

    function displayResponse(data) {
        responseOutput.textContent = JSON.stringify(data, null, 2);
    }

    // --- Lógica de Autenticación ---
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('reg-username').value;
        const password = document.getElementById('reg-password').value;
        const email = document.getElementById('reg-email').value;
        try {
            const data = await apiFetch(`${API_BASE_AUTH}/register`, {
                method: 'POST',
                body: JSON.stringify({ username, password, email, first_name: "Test", last_name: "User" })
            });
            displayResponse(data);
        } catch (error) {}
    });

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        try {
            const data = await apiFetch(`${API_BASE_AUTH}/login`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            currentJwt = data.token;
            jwtTokenDisplay.textContent = currentJwt;
            displayResponse(data);
        } catch (error) {}
    });

    // --- Lógica de Cursos ---
    document.getElementById('list-courses-btn').addEventListener('click', async () => {
        try {
            const data = await apiFetch(`${API_BASE_COURSES}/courses`);
            displayResponse(data);
        } catch (error) {}
    });

    document.getElementById('create-course-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentJwt) {
            alert('Necesitas iniciar sesión primero para obtener un token JWT.');
            return;
        }
        const title = document.getElementById('course-title').value;
        const description = document.getElementById('course-description').value;
        try {
            const data = await apiFetch(`${API_BASE_COURSES}/courses`, {
                method: 'POST',
                body: JSON.stringify({ title, description })
            });
            displayResponse(data);
        } catch (error) {}
    });

    // --- Lógica de Inscripciones ---
    document.getElementById('enroll-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentJwt) {
            alert('Necesitas iniciar sesión primero para obtener un token JWT.');
            return;
        }
        const course_id = document.getElementById('enroll-course-id').value;
        try {
            const data = await apiFetch(`${API_BASE_ENROLLMENTS}/enrollments`, {
                method: 'POST',
                body: JSON.stringify({ course_id })
            });
            displayResponse(data);
        } catch (error) {}
    });

    document.getElementById('my-courses-btn').addEventListener('click', async () => {
        if (!currentJwt) {
            alert('Necesitas iniciar sesión primero para obtener un token JWT.');
            return;
        }
        try {
            const data = await apiFetch(`${API_BASE_ENROLLMENTS}/enrollments/my-courses`);
            displayResponse(data);
        } catch (error) {}
    });
</script>
</body>
</html>